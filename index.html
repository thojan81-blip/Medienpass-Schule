<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitaler Medienpass Pro</title>
    
    <!-- Frameworks & Icons via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase Libraries (Version 10 Compat) - Optional für Cloud-Backup -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .quiz-modal-enter { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Design Tokens */
        .card-skill { border-left: 6px solid #22c55e; }
        .card-reflexion { border-left: 6px solid #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- FIREBASE CONFIG (Optional) ---
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        let db = null;
        if (firebaseConfig.apiKey) {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        }

        const APP_VERSION = "v2-pro-final";

        // Verbesserte Icon Komponente für maximale Zuverlässigkeit
        const Icon = ({ name, size = 24, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState("");

            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    const svg = window.lucide.icons[name].toSvg({
                        width: size,
                        height: size,
                        class: className,
                        'stroke-width': 2.5
                    });
                    setSvgHtml(svg);
                } else {
                    // Fallback falls Lucide noch lädt
                    const timer = setTimeout(() => {
                        if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                            setSvgHtml(window.lucide.icons[name].toSvg({ width: size, height: size, class: className }));
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, [name, size, className]);

            return <span className="inline-flex" dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        const curriculumData = {
            "5-6": {
                title: "Basis-Stufe",
                tasks: [
                    { id: 1, category: "Anwendung", title: "Hardware-Führerschein", desc: "Bedienung von Maus, Tastatur und Kamera.", quiz: [
                        { q: "Wie fährst du einen Computer sicher herunter?", a: ["Stecker ziehen", "Start-Menü -> Ein/Aus -> Herunterfahren", "Bildschirm ausschalten"], correct: 1 },
                        { q: "Wofür nutzt man meistens die rechte Maustaste?", a: ["Um Programme zu löschen", "Um ein Kontextmenü zu öffnen", "Zum Doppelklicken"], correct: 1 }
                    ]},
                    { id: 2, category: "Anwendung", title: "Dateimanagement", desc: "Ordnerhierarchien verstehen und Cloud nutzen.", quiz: [
                        { q: "Warum sollte man Dateien in Ordnern sortieren?", a: ["Damit der PC schneller wird", "Um sie schneller wiederzufinden", "Gegen Viren"], correct: 1 }
                    ]},
                    { id: 3, category: "Anwendung", title: "Textverarbeitung I", desc: "Grundfunktionen und PDF-Export.", quiz: [
                        { q: "Wie macht man eine Überschrift 'fett'?", a: ["Text markieren und 'B' klicken", "Ganz groß schreiben", "Unterstreichen"], correct: 0 }
                    ]},
                    { id: 4, category: "Umgang", title: "Netiquette", desc: "Regeln für den Klassenchat.", quiz: [
                        { q: "Was bedeutet SCHREIBEN IN GROSSBUCHSTABEN?", a: ["Ich bin schlau", "Ich schreie", "Tastatur kaputt"], correct: 1 }
                    ]},
                    { id: 5, category: "Umgang", title: "Cybermobbing-Schutz", desc: "Grenzen erkennen und Hilfe finden.", quiz: [
                        { q: "Erster Schritt bei Beleidigungen?", a: ["Zurückbeleidigen", "Screenshot machen", "PC wegwerfen"], correct: 1 }
                    ]},
                    { id: 6, category: "Umgang", title: "Suchmaschinen", desc: "Nutzung von Kindersuchmaschinen.", quiz: [
                        { q: "Welche Suche ist für Kinder?", a: ["FragFinn.de", "Amazon.de", "Google Bilder"], correct: 0 }
                    ]}
                ]
            },
            "7-8": {
                title: "Aufbau-Stufe",
                tasks: [
                    { id: 7, category: "Anwendung", title: "Präsentationsprofi", desc: "Foliendesign und Medieneinbettung." },
                    { id: 8, category: "Anwendung", title: "Medienproduktion", desc: "Grundlagen Video- und Bildschnitt." },
                    { id: 9, category: "Anwendung", title: "Tabellenkalkulation", desc: "Daten grafisch aufbereiten." },
                    { id: 10, category: "Umgang", title: "Urheberrecht", desc: "Fair Use und Creative Commons." },
                    { id: 11, category: "Umgang", title: "Quellenkritik", desc: "Fake News Mechanismen erkennen." },
                    { id: 12, category: "Umgang", title: "Datenschutz", desc: "Tracker und Social Media Profile." }
                ]
            },
            "9-10": {
                title: "Profi-Stufe",
                tasks: [
                    { id: 13, category: "Anwendung", title: "KI-Produktivität", desc: "Effektives Prompting und Reflexion." },
                    { id: 14, category: "Anwendung", title: "Digitale Bewerbung", desc: "E-Portfolio und Profile." },
                    { id: 15, category: "Anwendung", title: "Projektmanagement", desc: "Kollaboratives Arbeiten (Agile)." },
                    { id: 16, category: "Umgang", title: "KI-Ethik", desc: "Verantwortung von Algorithmen." },
                    { id: 17, category: "Umgang", title: "Zivilcourage", desc: "Umgang mit Hate Speech im Netz." },
                    { id: 18, category: "Umgang", title: "Digitaler Fußabdruck", desc: "Eigene Biografie reflektieren." }
                ]
            }
        };

        const App = () => {
            const [msUser, setMsUser] = useState({ userId: 'local-user', userDetails: 'Gast-Schüler/in' });
            const [viewMode, setViewMode] = useState('student'); 
            const [activeStage, setActiveStage] = useState("5-6");
            const [completedTasks, setCompletedTasks] = useState([]);
            const [activeQuiz, setActiveQuiz] = useState(null);
            const [quizStep, setQuizStep] = useState(0);
            const [quizError, setQuizError] = useState(false);
            const [teacherCode, setTeacherCode] = useState("");

            useEffect(() => {
                const saved = localStorage.getItem(`medienpass_progress_${APP_VERSION}`);
                if (saved) setCompletedTasks(JSON.parse(saved));

                fetch('/.auth/me').then(res => res.json()).then(data => {
                    if (data.clientPrincipal) setMsUser(data.clientPrincipal);
                }).catch(() => {});
            }, []);

            useEffect(() => {
                if (db && msUser.userId !== 'local-user') {
                    db.doc(`medienpass/${APP_VERSION}/users/${msUser.userId}`).get().then(doc => {
                        if (doc.exists) setCompletedTasks(doc.data().completedTasks || []);
                    });
                }
            }, [msUser.userId]);

            const saveProgress = async (tasks) => {
                setCompletedTasks(tasks);
                localStorage.setItem(`medienpass_progress_${APP_VERSION}`, JSON.stringify(tasks));

                if (db && msUser.userId !== 'local-user') {
                    const payload = { 
                        completedTasks: tasks, 
                        userDetails: msUser.userDetails,
                        progress: Math.round((tasks.length / 18) * 100),
                        lastUpdated: new Date().toISOString()
                    };
                    await db.doc(`medienpass/${APP_VERSION}/users/${msUser.userId}`).set(payload, { merge: true });
                }
            };

            const toggleTask = (id) => {
                const next = completedTasks.includes(id) 
                    ? completedTasks.filter(t => t !== id) 
                    : [...completedTasks, id];
                saveProgress(next);
            };

            const handleQuizAnswer = (idx) => {
                if (idx === activeQuiz.quiz[quizStep].correct) {
                    setQuizError(false);
                    if (quizStep + 1 < activeQuiz.quiz.length) {
                        setQuizStep(s => s + 1);
                    } else {
                        toggleTask(activeQuiz.id);
                        setActiveQuiz(null);
                    }
                } else {
                    setQuizError(true);
                }
            };

            const totalProgress = Math.round((completedTasks.length / 18) * 100);

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="bg-white border-b px-6 h-20 flex items-center justify-between shadow-sm sticky top-0 z-40">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setViewMode('student')}>
                            <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg">
                                <Icon name="shield-check" size={28} />
                            </div>
                            <div>
                                <h1 className="font-black text-xl tracking-tighter uppercase text-slate-800">Medienpass <span className="text-blue-600">Pro</span></h1>
                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Digitale Kompetenz</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <button onClick={() => setViewMode(viewMode === 'teacher' ? 'student' : 'teacher-auth')} className="text-[10px] font-black uppercase text-slate-400 hover:text-blue-600 transition-colors">
                                {viewMode === 'teacher' ? 'Zurück' : 'Lehrer-Bereich'}
                            </button>
                            <div className="h-8 w-px bg-slate-100"></div>
                            <div className="flex items-center gap-2 text-xs font-black text-slate-700">
                                <Icon name="user" size={18} className="text-slate-300" />
                                {msUser.userDetails.split(' ')[0]}
                            </div>
                        </div>
                    </header>

                    <main className="flex-grow max-w-6xl mx-auto w-full p-6 sm:p-10">
                        {viewMode === 'student' && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <div className="bg-slate-900 rounded-[3rem] p-8 sm:p-12 text-white shadow-2xl mb-12 relative overflow-hidden">
                                    <div className="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-8">
                                        <div>
                                            <h2 className="text-4xl sm:text-5xl font-black mb-4 tracking-tighter">Dein Portfolio.</h2>
                                            <p className="text-slate-400 max-w-md font-medium text-lg leading-relaxed">
                                                Dokumentiere deine Reise durch die digitale Welt von der 5. Klasse bis zum Abschluss.
                                            </p>
                                        </div>
                                        <div className="bg-white/5 backdrop-blur-md p-8 rounded-[2.5rem] border border-white/10 text-center min-w-[200px]">
                                            <p className="text-[10px] uppercase font-black tracking-[0.2em] text-blue-400 mb-2">Fortschritt</p>
                                            <div className="text-7xl font-black mb-4">{totalProgress}%</div>
                                            <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div className="bg-blue-500 h-full transition-all duration-1000" style={{ width: `${totalProgress}%` }}></div>
                                            </div>
                                        </div>
                                    </div>
                                    <Icon name="award" size={400} className="absolute -right-20 -bottom-20 opacity-5" />
                                </div>

                                <div className="flex gap-2 mb-12 overflow-x-auto pb-4 scrollbar-hide no-print">
                                    {Object.keys(curriculumData).map(k => (
                                        <button key={k} onClick={() => setActiveStage(k)} className={`px-10 py-5 rounded-[2rem] font-black transition-all whitespace-nowrap ${activeStage === k ? 'bg-blue-600 text-white shadow-xl scale-105' : 'bg-white text-slate-400 hover:bg-slate-100'}`}>
                                            KLASSE {k}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                                    <section>
                                        <h3 className="text-2xl font-black mb-8 uppercase tracking-tighter flex items-center gap-3">
                                            <Icon name="pen-tool" className="text-green-500" /> Skills (Anwendung)
                                        </h3>
                                        <div className="space-y-6">
                                            {curriculumData[activeStage].tasks.filter(t => t.category === "Anwendung").map(t => (
                                                <div key={t.id} onClick={() => t.quiz && !completedTasks.includes(t.id) ? (setActiveQuiz(t), setQuizStep(0), setQuizError(false)) : toggleTask(t.id)} className={`p-8 rounded-[2.5rem] border-2 cursor-pointer transition-all flex gap-6 card-skill ${completedTasks.includes(t.id) ? 'border-blue-500 bg-white shadow-xl shadow-blue-50' : 'border-slate-100 bg-white hover:border-slate-300'}`}>
                                                    <div className={completedTasks.includes(t.id) ? 'text-blue-600' : 'text-slate-200'}>
                                                        <Icon name={completedTasks.includes(t.id) ? "check-circle" : "circle"} size={36} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <h4 className={`font-black text-xl mb-1 ${completedTasks.includes(t.id) ? 'text-slate-900' : 'text-slate-600'}`}>{t.title}</h4>
                                                        <p className="text-slate-400 text-sm font-medium leading-relaxed">{t.desc}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </section>

                                    <section>
                                        <h3 className="text-2xl font-black mb-8 uppercase tracking-tighter flex items-center gap-3">
                                            <Icon name="globe" className="text-blue-600" /> Reflexion (Umgang)
                                        </h3>
                                        <div className="space-y-6">
                                            {curriculumData[activeStage].tasks.filter(t => t.category === "Umgang").map(t => (
                                                <div key={t.id} onClick={() => t.quiz && !completedTasks.includes(t.id) ? (setActiveQuiz(t), setQuizStep(0), setQuizError(false)) : toggleTask(t.id)} className={`p-8 rounded-[2.5rem] border-2 cursor-pointer transition-all flex gap-6 card-reflexion ${completedTasks.includes(t.id) ? 'border-blue-500 bg-white shadow-xl shadow-blue-50' : 'border-slate-100 bg-white hover:border-slate-300'}`}>
                                                    <div className={completedTasks.includes(t.id) ? 'text-blue-600' : 'text-slate-200'}>
                                                        <Icon name={completedTasks.includes(t.id) ? "check-circle" : "circle"} size={36} />
                                                    </div>
                                                    <div className="flex-1">
                                                        <h4 className={`font-black text-xl mb-1 ${completedTasks.includes(t.id) ? 'text-slate-900' : 'text-slate-600'}`}>{t.title}</h4>
                                                        <p className="text-slate-400 text-sm font-medium leading-relaxed">{t.desc}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                </div>
                            </div>
                        )}

                        {viewMode === 'teacher-auth' && (
                            <div className="max-w-md mx-auto mt-20 bg-white p-12 rounded-[3rem] shadow-2xl text-center border">
                                <Icon name="lock" size={48} className="mx-auto mb-6 text-slate-300" />
                                <h2 className="text-3xl font-black mb-6">Lehrer-Bereich</h2>
                                <input type="password" placeholder="Passwort..." className="w-full bg-slate-50 border-2 rounded-2xl p-5 mb-4 text-center font-bold outline-none focus:border-blue-600 transition-all" onChange={e => setTeacherCode(e.target.value)} />
                                <button onClick={() => teacherCode === "Lehrer2026" ? setViewMode('teacher') : alert("Code ungültig")} className="w-full bg-slate-900 text-white p-5 rounded-2xl font-black shadow-xl">Anmelden</button>
                            </div>
                        )}
                        
                        {viewMode === 'teacher' && (
                            <div className="animate-in fade-in text-center py-20">
                                <Icon name="database" size={64} className="mx-auto mb-6 text-slate-200" />
                                <h2 className="text-2xl font-black text-slate-400 italic">Dashboard bereit für Firebase.</h2>
                            </div>
                        )}
                    </main>

                    {activeQuiz && (
                        <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-[4rem] p-10 sm:p-16 max-w-2xl w-full shadow-2xl quiz-modal-enter relative">
                                <button onClick={() => setActiveQuiz(null)} className="absolute top-10 right-10 text-slate-300 hover:text-slate-900"><Icon name="x" size={32} /></button>
                                <h3 className="text-3xl font-black text-slate-900 mb-10">{activeQuiz.quiz[quizStep].q}</h3>
                                <div className="space-y-4 mb-10">
                                    {activeQuiz.quiz[quizStep].a.map((ans, i) => (
                                        <button key={i} onClick={() => handleQuizAnswer(i)} className="w-full text-left p-6 rounded-3xl border-2 border-slate-50 hover:border-blue-500 hover:bg-blue-50 font-bold transition-all text-slate-700 flex justify-between items-center group">
                                            <span>{ans}</span>
                                            <Icon name="chevron-right" size={24} className="opacity-0 group-hover:opacity-100 text-blue-600 transition-all" />
                                        </button>
                                    ))}
                                </div>
                                {quizError && <div className="bg-red-50 text-red-500 font-bold p-6 rounded-3xl animate-bounce mb-6 text-center">Leider falsch. Probier es nochmal!</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
